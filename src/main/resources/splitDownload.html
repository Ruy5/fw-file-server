<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Chunk Download</title>
</head>
<body>
<button id="downloadBtn">Download File</button>

<script>
    document.getElementById('downloadBtn').addEventListener('click', downloadFile);

    async function downloadFile() {
        const identifier = 'wallhaven-werdv6.png';  // Replace with actual identifier
        const chunkSize = 1024 * 1024;  // 1 MB chunks
        let chunkNumber = 0;
        let chunks = [];
        let fileSize = 0;

        // Fetch the first chunk to determine the file size
        let firstResponse = await fetchChunk(identifier, chunkNumber, chunkSize);
        if (!firstResponse) {
            console.error('Failed to download the first chunk');
            return;
        }

        fileSize = parseInt(firstResponse.headers.get('Content-Length'));
        console.log(">1", fileSize)
        await firstResponse.blob()
        console.log(">1-2")
        chunks.push(await firstResponse.blob());
        console.log(">2", fileSize)
        chunkNumber++;

        console.log(`${chunkNumber * chunkSize} < ${fileSize}}`)
        while (chunkNumber * chunkSize < fileSize) {
            console.log(chunkNumber)
            let chunkResponse = await fetchChunk(identifier, chunkNumber, chunkSize);
            if (chunkResponse) {
                chunks.push(await chunkResponse.blob());
                chunkNumber++;
            } else {
                console.error('Failed to download chunk', chunkNumber);
                return;
            }
        }

        const blob = new Blob(chunks);
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'downloaded-file';  // Replace with the desired file name
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    }

    async function fetchChunk(identifier, chunkNumber, chunkSize) {
        const response = await fetch(`http://localhost:1024/upload/chunk?identifier=${identifier}&chunkNumber=${chunkNumber}&chunkSize=${chunkSize}`);
        if (response.status === 206) {
            return response;
        } else {
            return null;
        }
    }
</script>
</body>
</html>
